<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IoT Smart Parking â€” Simulation</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

    :root{
      --bg:linear-gradient(180deg,#05070a 0%, #071021 60%);
      --glass: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.62);
      --panel: rgba(255,255,255,0.03);
    }
    html,body { height:100%; }
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto; background:var(--bg); color:#e6eef8;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* glass card */
    .glass {
      background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.015));
      border: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(8px) saturate(110%);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.7);
    }

    /* slot 3D card */
    .slot-card { perspective:900px; transition: transform .2s cubic-bezier(.2,.9,.2,1), box-shadow .2s; }
    .slot-card:hover { transform: translateY(-8px) rotateX(2deg) scale(1.02); box-shadow: 0 22px 48px rgba(2,6,23,0.75); }
    .slot-inner { border-radius:12px; padding:14px; min-height:140px; display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; overflow:visible; transition: all .18s ease; }

    /* statuses */
    .status-available { background: linear-gradient(180deg,#043025,#0b3f2f); border:1px solid rgba(99,255,151,0.06); }
    .status-occupied  { background: linear-gradient(180deg,#2b0202,#3c0b0b); border:1px solid rgba(255,90,90,0.06); }
    .status-reserved  { background: linear-gradient(180deg,#503500,#6b4a00); border:1px solid rgba(255,212,70,0.06); }
    .status-offline   { background: linear-gradient(180deg,#12131a,#1c2430); border:1px solid rgba(255,255,255,0.02); opacity:.68; filter:grayscale(.25); }

    /* glows */
    .glow-green { box-shadow: 0 6px 36px rgba(16,185,129,0.12), inset 0 -6px 30px rgba(16,185,129,0.02); }
    .glow-red   { box-shadow: 0 6px 36px rgba(248,113,113,0.12), inset 0 -6px 30px rgba(248,113,113,0.03); }
    .glow-amber { box-shadow: 0 6px 36px rgba(250,204,21,0.09), inset 0 -6px 24px rgba(250,204,21,0.03); }

    .slot-number { position:absolute; left:10px; top:8px; background:rgba(0,0,0,0.2); padding:6px 8px; border-radius:8px; font-weight:700; font-size:13px; backdrop-filter:blur(4px); }
    .slot-badge { position:absolute; right:10px; top:8px; padding:6px 9px; border-radius:999px; display:flex; gap:8px; align-items:center; font-weight:700; font-size:12px; backdrop-filter:blur(4px); }

    .car-area { width:84px; height:50px; display:flex; align-items:center; justify-content:center; position:relative; }
    .car-icon { width:70px; height:36px; transition: transform .36s cubic-bezier(.2,.9,.2,1), opacity .25s ease; will-change:transform,opacity; }
    .idle-bounce { animation: parked-bounce 2.2s ease-in-out infinite; transform-origin:center bottom; }
    @keyframes parked-bounce { 0% { transform: translateY(0) } 50% { transform: translateY(-5px) } 100% { transform: translateY(0) } }

    .slot-actions { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:8px; opacity:0; pointer-events:none; transition:opacity .14s, transform .14s; }
    .slot-card:hover .slot-actions { opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(0); }

    .btn-ghost { background: rgba(0,0,0,0.28); padding:8px 10px; border-radius:10px; font-weight:700; font-size:13px; border:1px solid rgba(255,255,255,0.03); }

    /* floating car used for animations */
    .floating-car { position:fixed; z-index:80; width:80px; height:44px; pointer-events:none; transform:translateZ(0); filter: drop-shadow(0 20px 40px rgba(2,6,23,0.6)); transition: transform .85s cubic-bezier(.16,.84,.2,1), left .85s, top .85s, opacity .3s; }

    /* fade / slide */
    .fade-in { animation: fadeIn .28s ease forwards; }
    .fade-out { animation: fadeOut .24s ease forwards; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px) } to { opacity:1; transform: translateY(0) } }
    @keyframes fadeOut { from { opacity:1; transform: translateY(0) } to { opacity:0; transform: translateY(-10px) } }

    /* quick responsive */
    @media (max-width:640px) {
      .car-area { width:68px; height:42px; }
      .car-icon { width:56px; height:28px; }
    }
    .muted { color:var(--muted); }
    pre#jsonPreview { background:rgba(0,0,0,0.35); padding:12px; border-radius:10px; font-size:12px; max-height:200px; overflow:auto; }

    /* log box scrollable */
    #logBox { max-height:200px; overflow:auto; }
  </style>
</head>
<body class="p-6">

  <main class="max-w-7xl mx-auto flex flex-col gap-6">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-extrabold text-teal-300">ðŸš— IoT Smart Parking â€” Advanced Web Simulation</h1>
        <p class="text-sm muted mt-1">Refined visuals, moving cars, reservations, fees, analytics, persistence.</p>
      </div>

      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="text-xs muted">Available</div>
          <div id="available" class="text-xl font-bold text-green-300">0</div>
        </div>
        <div class="text-right">
          <div class="text-xs muted">Occupied</div>
          <div id="occupied" class="text-xl font-bold text-red-300">0</div>
        </div>
        <button id="exportJSON" class="px-3 py-2 rounded-md bg-sky-600 hover:bg-sky-500 text-sm">Export JSON</button>
      </div>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="glass p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs muted">Total slots</div>
            <div id="totalSlotsText" class="text-2xl font-bold">8</div>
          </div>
          <div>
            <div class="text-xs muted">Gate</div>
            <div id="gate" class="px-3 py-1 rounded-full bg-red-700/20 text-red-200 text-sm font-semibold">Closed</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div class="p-3 rounded bg-black/20">
            <div class="text-xs muted">Reserved</div>
            <div id="reservedCount" class="text-lg font-semibold text-amber-300">0</div>
          </div>
          <div class="p-3 rounded bg-black/20">
            <div class="text-xs muted">Rate / hr</div>
            <div class="flex gap-2 items-center">
              <input id="rateInput" type="number" min="0" step="0.1" value="2" class="w-24 p-2 rounded bg-black/20 text-white text-sm" />
              <button id="applyRateBtn" class="px-3 py-2 rounded-md bg-emerald-600 hover:bg-emerald-500 text-sm">Apply</button>
            </div>
          </div>
        </div>

        <div class="flex gap-2 items-center">
          <label class="text-sm muted">Total slots</label>
          <input id="totalSlotsInput" type="number" min="1" max="48" value="8" class="w-20 p-2 rounded bg-black/20 text-white text-sm" />
          <button id="applySlotsBtn" class="px-3 py-2 rounded-md bg-sky-600 hover:bg-sky-500 text-sm">Apply</button>
          <button id="resetSlotsBtn" class="px-3 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-sm ml-auto">Reset All</button>
        </div>

        <div class="flex gap-2">
          <button id="enterBtn" class="flex-1 px-3 py-2 rounded-md bg-green-600 hover:bg-green-500 text-sm">Simulate Enter</button>
          <button id="exitBtn" class="flex-1 px-3 py-2 rounded-md bg-red-600 hover:bg-red-500 text-sm">Simulate Exit</button>
        </div>

        <div class="flex gap-2 items-center">
          <button id="reserveBtn" class="px-3 py-2 rounded-md bg-amber-600 hover:bg-amber-500 text-sm">Reserve Random</button>
          <button id="reserveExpiryBtn" class="px-3 py-2 rounded-md bg-amber-700 hover:bg-amber-600 text-sm">Reserve (2m)</button>
          <button id="toggleSensorNoise" class="px-3 py-2 rounded-md bg-gray-700 hover:bg-gray-600 text-sm">Sensor Noise: Off</button>
        </div>

        <div>
          <div class="text-xs muted mb-1">Auto simulate</div>
          <div class="flex gap-2 items-center">
            <input id="autoToggle" type="checkbox" class="h-5 w-9" />
            <input id="speedInput" type="number" min="200" value="900" class="w-28 p-2 rounded bg-black/20 text-white text-sm" />
            <label class="text-sm muted">ms</label>
            <button id="autoBurst" class="ml-auto px-3 py-1 rounded-md bg-indigo-600 hover:bg-indigo-500 text-sm">Burst 5</button>
          </div>
        </div>

        <div>
          <div class="text-xs muted mb-1">Logs</div>
          <div id="logBox" class="p-2 rounded bg-black/25 text-sm" style="min-height:120px;"></div>
        </div>
      </div>

      <div class="glass p-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-xs muted">Occupancy (history)</div>
            <div class="text-sm muted">Real-time sampling</div>
          </div>
          <div class="flex gap-2">
            <button id="downloadCSV" class="px-3 py-2 rounded-md bg-sky-600 hover:bg-sky-500 text-sm">Download CSV</button>
            <button id="exportJSONBtn" class="px-3 py-2 rounded-md bg-emerald-600 hover:bg-emerald-500 text-sm">Export JSON</button>
          </div>
        </div>
        <canvas id="occupancyChart" class="w-full h-36 mb-3"></canvas>
        <div>
          <div class="text-xs muted mb-1">JSON Preview</div>
          <pre id="jsonPreview"></pre>
        </div>
      </div>

      <div class="glass p-4 space-y-3">
        <div class="text-xs muted">Quick actions</div>
        <div class="flex gap-2">
          <button id="exportJSONTop" class="px-3 py-2 rounded-md bg-sky-600 hover:bg-sky-500 text-sm">Export State</button>
          <button id="downloadCSVTop" class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-sm">CSV</button>
        </div>

        <div>
          <label class="text-xs muted">Search slot</label>
          <div class="flex gap-2 mt-2">
            <input id="searchSlot" type="number" min="1" placeholder="Slot #" class="w-28 p-2 rounded bg-black/20 text-white text-sm" />
            <button id="searchBtn" class="px-3 py-2 rounded-md bg-slate-700 hover:bg-slate-600 text-sm">Find</button>
          </div>
        </div>

        <div>
          <div class="text-xs muted mb-1">Tips</div>
          <div class="text-sm muted">Tap/hover a slot to reveal actions. Try entry/exit to watch cars move.</div>
        </div>
      </div>
    </section>

    <section class="glass p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Parking Layout</h2>
        <div class="text-sm muted">Tap / hover card for actions</div>
      </div>

      <div id="slots" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>

    <!-- modal -->
    <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
      <div class="w-11/12 max-w-md p-4 rounded-lg glass">
        <div class="flex items-start justify-between">
          <div>
            <h3 id="modalTitle" class="text-lg font-bold">Slot</h3>
            <div id="modalSubtitle" class="text-xs muted">details</div>
          </div>
          <button id="modalClose" class="text-sm muted">Close</button>
        </div>

        <div class="mt-3 space-y-2">
          <div class="text-sm">Status: <span id="modalStatus" class="font-semibold"></span></div>
          <div class="text-sm">Entered at: <span id="modalEnterAt" class="muted">-</span></div>
          <div class="text-sm">Reserved until: <span id="modalReservedUntil" class="muted">-</span></div>
          <div class="text-sm">Elapsed: <span id="modalElapsed" class="muted">-</span></div>
          <div class="text-sm">Current fee: <span id="modalFee" class="muted">0.00</span></div>
        </div>

        <div class="flex gap-2 mt-4">
          <button id="modalForceFree" class="flex-1 px-3 py-2 rounded-md bg-green-600 hover:bg-green-500 text-sm">Free Slot</button>
          <button id="modalForceOccupy" class="flex-1 px-3 py-2 rounded-md bg-red-600 hover:bg-red-500 text-sm">Occupy Now</button>
        </div>
      </div>
    </div>

    <div id="animationLayer" aria-hidden="true"></div>

    <footer class="text-xs muted text-center mt-2">State persists in localStorage. Export for reports.</footer>
  </main>

<script>
/* ---------- Utilities & SVGs ---------- */
const el = id => document.getElementById(id);
const nowIso = () => new Date().toISOString();
const ts = () => Date.now();

const carSVG = (color = '#fff') => `
  <svg class="car-icon" viewBox="0 0 120 60" xmlns="http://www.w3.org/2000/svg" fill="none" aria-hidden="true">
    <defs>
      <linearGradient id="cg" x1="0" x2="1">
        <stop offset="0" stop-color="${color}" stop-opacity="0.96"/>
        <stop offset="1" stop-color="${color}" stop-opacity="0.8"/>
      </linearGradient>
    </defs>
    <rect x="10" y="18" width="100" height="22" rx="6" fill="url(#cg)" opacity="0.98"/>
    <path d="M22 40c0 3-3 6-6 6v0c3 0 6-3 6-6z" fill="#111"/>
    <path d="M98 40c0 3 3 6 6 6v0c-3 0-6-3-6-6z" fill="#111"/>
    <rect x="30" y="8" width="44" height="16" rx="4" fill="#000" opacity="0.06"/>
  </svg>`;

/* ---------- Simple State Manager ---------- */
class Store {
  constructor() {
    this.key = 'iot_parking_v4';
    this.default = { totalSlots: 8, ratePerHour: 2.0, slots: [], gateStatus: 'Closed', logs: [], sensorNoise: false };
    this.listeners = [];
    this.load();
  }

  load() {
    const raw = localStorage.getItem(this.key);
    if (!raw) {
      this.totalSlots = this.default.totalSlots;
      this.ratePerHour = this.default.ratePerHour;
      this.slots = [];
      for (let i=1;i<=this.totalSlots;i++) this.slots.push(this._makeSlot(i));
      this.gateStatus = 'Closed';
      this.logs = [];
      this.sensorNoise = false;
      this.save();
      return;
    }
    try {
      const parsed = JSON.parse(raw);
      this.totalSlots = parsed.totalSlots ?? this.default.totalSlots;
      this.ratePerHour = parsed.ratePerHour ?? this.default.ratePerHour;
      this.slots = parsed.slots ?? [];
      this.gateStatus = parsed.gateStatus ?? 'Closed';
      this.logs = parsed.logs ?? [];
      this.sensorNoise = parsed.sensorNoise ?? false;
      // sync slots count
      if (this.slots.length < this.totalSlots) {
        for (let i=this.slots.length+1;i<=this.totalSlots;i++) this.slots.push(this._makeSlot(i));
      } else if (this.slots.length > this.totalSlots) {
        this.slots = this.slots.slice(0,this.totalSlots);
      }
    } catch(e) {
      console.error('state parse fail', e);
      localStorage.removeItem(this.key);
      this.load();
    }
  }

  save() { localStorage.setItem(this.key, JSON.stringify({
    totalSlots:this.totalSlots, ratePerHour:this.ratePerHour, slots:this.slots, gateStatus:this.gateStatus, logs:this.logs, sensorNoise:this.sensorNoise
  })); }

  subscribe(fn) { this.listeners.push(fn); fn(this.snapshot()); return () => this.listeners = this.listeners.filter(f=>f!==fn); }
  _emit() { const snap=this.snapshot(); this.save(); this.listeners.forEach(f=>f(snap)); }

  snapshot() { return {
    totalSlots:this.totalSlots, ratePerHour:this.ratePerHour,
    slots: JSON.parse(JSON.stringify(this.slots)), gateStatus:this.gateStatus, logs:this.logs.slice(), sensorNoise:this.sensorNoise
  }; }

  _makeSlot(id){ return { id, status:'available', enteredAt:null, reservedUntil:null, lastSeen:ts() }; }

  log(text){ this.logs.unshift({time:(new Date()).toLocaleTimeString(), text}); if(this.logs.length>500) this.logs.length=500; this._emit(); }

  ensureSlots(n){
    if(n===this.totalSlots) return;
    this.totalSlots=n;
    if(this.slots.length<n) for(let i=this.slots.length+1;i<=n;i++) this.slots.push(this._makeSlot(i));
    else if(this.slots.length>n) this.slots=this.slots.slice(0,n);
    this.log(`total slots -> ${n}`); this._emit();
  }

  setRate(r){ this.ratePerHour=r; this.log(`rate -> ${r.toFixed(2)}/hr`); this._emit(); }

  occupy(slotId){
    const s=this.slots.find(x=>x.id===slotId); if(!s) return false;
    if(s.status==='occupied') return false;
    s.status='occupied'; s.enteredAt=ts(); s.reservedUntil=null; this.gatePulse(); this.log(`occupied #${slotId}`); this._emit(); return true;
  }

  free(slotId){
    const s=this.slots.find(x=>x.id===slotId); if(!s) return false;
    if(s.status!=='occupied'){ s.status='available'; s.enteredAt=null; s.reservedUntil=null; this.log(`slot #${slotId} set available`); this._emit(); return true; }
    const fee=this.feeFor(s); s.status='available'; s.enteredAt=null; s.reservedUntil=null; this.gatePulse(); this.log(`exited #${slotId} fee ${fee.toFixed(2)}`); this._emit(); return true;
  }

  toggleOffline(slotId){ const s=this.slots.find(x=>x.id===slotId); if(!s) return; s.status = s.status==='offline' ? 'available' : 'offline'; s.enteredAt=null; s.reservedUntil=null; this.log(`slot #${slotId} -> ${s.status}`); this._emit(); }

  reserve(slotId, durationMs=120000){
    const s=this.slots.find(x=>x.id===slotId); if(!s||s.status!=='available') return false;
    s.status='reserved'; s.reservedUntil=ts()+durationMs; this.log(`reserved #${slotId} ${Math.round(durationMs/1000)}s`); this._emit(); return true;
  }

  reserveRandom(durationMs=120000){
    const s=this.slots.find(x=>x.status==='available'); if(!s){ this.log('reserve failed: none'); return false; }
    s.status='reserved'; s.reservedUntil=ts()+durationMs; this.log(`reserved random #${s.id}`); this._emit(); return true;
  }

  feeFor(slot){ if(!slot||!slot.enteredAt) return 0; const hours=(ts()-slot.enteredAt)/3600000; return hours*(this.ratePerHour||0); }

  gatePulse(){ this.gateStatus='Open'; this._emit(); setTimeout(()=>{ this.gateStatus='Closed'; this._emit(); },800); }

  expireReservations(){
    const now=ts();
    this.slots.forEach(s=>{ if(s.status==='reserved' && s.reservedUntil && s.reservedUntil<=now){ s.status='available'; s.reservedUntil=null; this.log(`reservation expired #${s.id}`); } });
    this._emit();
  }
}
const store = new Store();

/* ---------- Animation helpers ---------- */
function createFloating(color='#fff'){
  const el = document.createElement('div'); el.className='floating-car'; el.innerHTML = carSVG(color); document.body.appendChild(el); return el;
}
function posFromRect(r, elW, elH){ return { left: r.left + r.width/2 - elW/2, top: r.top + r.height/2 - elH/2 }; }

function animateFromTo(startRect, destRect, color='#fff'){
  const f = createFloating(color);
  // initial layout (offset slightly below to mimic approach)
  f.style.left = (startRect.left - 20) + 'px';
  f.style.top  = (startRect.top + 10) + 'px';
  f.style.opacity = '0';
  f.style.transform = 'scale(.95) translateY(12px)';
  requestAnimationFrame(()=> {
    const dest = posFromRect(destRect, f.offsetWidth, f.offsetHeight);
    f.style.transition = 'left .85s cubic-bezier(.16,.84,.2,1), top .85s cubic-bezier(.16,.84,.2,1), transform .85s, opacity .24s';
    f.style.left = `${dest.left}px`; f.style.top = `${dest.top}px`; f.style.opacity='1'; f.style.transform='scale(1) translateY(0)';
  });
  return new Promise(resolve=> setTimeout(()=> resolve(f), 880));
}

async function enterAnimationToSlot(slotElement, color='#a8ffb7'){
  // start near bottom center
  const vpW = document.documentElement.clientWidth, vpH = document.documentElement.clientHeight;
  const startRect = { left: vpW/2 - 40, top: vpH - 90, width: 80, height: 40 };
  const destRect = slotElement.getBoundingClientRect();
  const f = await animateFromTo(startRect, destRect, color);
  f.style.opacity= '0'; setTimeout(()=>f.remove(), 260);
}

async function exitAnimationFromSlot(slotElement, color='#ffb4b4'){
  const startRect = slotElement.getBoundingClientRect();
  const destRect = { left: window.innerWidth + 160, top: -140, width: 80, height: 40 };
  const f = await animateFromTo(startRect, destRect, color);
  f.style.opacity='0'; setTimeout(()=>f.remove(), 340);
}

/* ---------- Rendering (with diffing to avoid full re-renders) ---------- */
const slotNodes = new Map(); // id -> DOM node

function makeSlotElement(slot){
  const wrap = document.createElement('div'); wrap.className='slot-card';
  wrap.dataset.slotId = slot.id;

  const inner = document.createElement('div'); inner.className='slot-inner';
  inner.setAttribute('aria-live', 'polite');

  // number & badge
  const num = document.createElement('div'); num.className='slot-number'; num.textContent = `#${slot.id}`; inner.appendChild(num);

  const badge = document.createElement('div'); badge.className='slot-badge'; inner.appendChild(badge);

  // car area
  const carArea = document.createElement('div'); carArea.className='car-area';
  carArea.innerHTML = carSVG('#fff');
  inner.appendChild(carArea);

  // info
  const info = document.createElement('div'); info.className='slot-info mt-3 text-xs muted text-center';
  inner.appendChild(info);

  // actions
  const actions = document.createElement('div'); actions.className='slot-actions';
  actions.innerHTML = `<button class="btn-ghost" data-action="toggle" data-id="${slot.id}">${slot.status==='offline'?'Enable':'Toggle'}</button>
                       <button class="btn-ghost" data-action="reserve" data-id="${slot.id}">Reserve</button>
                       <button class="btn-ghost" data-action="details" data-id="${slot.id}">Details</button>`;
  inner.appendChild(actions);

  // hook actions once
  actions.querySelectorAll('button').forEach(b=>{
    const act = b.dataset.action, id = parseInt(b.dataset.id);
    b.addEventListener('click', e=>{ e.stopPropagation();
      if(act==='toggle') store.toggleOffline(id);
      else if(act==='reserve'){ if(!store.reserve(id,120000)) alert('Cannot reserve'); }
      else if(act==='details') openModal(id);
    });
  });

  wrap.addEventListener('click', ()=> openModal(slot.id));
  wrap.appendChild(inner);
  wrap.classList.add('fade-in');
  return wrap;
}

function updateSlotNode(node, slot){
  const inner = node.querySelector('.slot-inner');
  // reset classes
  inner.className = 'slot-inner';
  if(slot.status==='available') inner.classList.add('status-available','glow-green');
  else if(slot.status==='occupied') inner.classList.add('status-occupied','glow-red');
  else if(slot.status==='reserved') inner.classList.add('status-reserved','glow-amber');
  else inner.classList.add('status-offline');

  // number (shouldn't change but keep in sync)
  const num = node.querySelector('.slot-number');
  if(num) num.textContent = `#${slot.id}`;

  // badge
  const badge = node.querySelector('.slot-badge');
  if(badge){
    if(slot.status==='available') badge.innerHTML = `<span class="text-xs muted">FREE</span>`;
    else if(slot.status==='occupied') badge.innerHTML = `<svg class="w-4 h-4 text-red-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 7h18M5 7l1-3h12l1 3M7 10v8M17 10v8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="text-xs font-semibold text-red-200">PARKED</span>`;
    else if(slot.status==='reserved') badge.innerHTML = `<svg class="w-4 h-4 text-amber-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 11V6a4 4 0 10-8 0v5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="text-xs font-semibold text-amber-200">RESERVED</span>`;
    else badge.innerHTML = `<span class="text-xs muted">OFFLINE</span>`;
  }

  // car area
  const carArea = node.querySelector('.car-area');
  if(carArea){
    carArea.innerHTML = slot.status==='occupied' ? carSVG('#ffb4b4') : carSVG('#fff');
    const icon = carArea.querySelector('.car-icon');
    if(icon){
      if(slot.status==='occupied') icon.classList.add('idle-bounce');
      else icon.classList.remove('idle-bounce');
    }
  }

  // info
  const info = node.querySelector('.slot-info');
  if(info){
    if(slot.status==='occupied') info.textContent = 'Entered: ' + (slot.enteredAt ? new Date(slot.enteredAt).toLocaleTimeString() : '-');
    else if(slot.status==='reserved') info.textContent = 'Reserved until: ' + (slot.reservedUntil ? new Date(slot.reservedUntil).toLocaleTimeString() : '-');
    else if(slot.status==='offline') info.textContent = 'Out of service'; else info.textContent = 'Available';
  }

  // ensure actions buttons data-id (in case slot ids changed due to resize)
  const actions = node.querySelector('.slot-actions');
  if(actions){
    actions.querySelectorAll('button').forEach(b=>{
      const act = b.dataset.action;
      b.dataset.id = slot.id;
      if(act === 'toggle') b.textContent = slot.status==='offline' ? 'Enable' : 'Toggle';
    });
  }
}

function renderGrid(snapshot, highlightId=null){
  const container = el('slots');

  // remove nodes for slots that no longer exist
  const existingIds = new Set(snapshot.slots.map(s=>s.id));
  for(const [id, node] of slotNodes.entries()){
    if(!existingIds.has(Number(id))){
      node.remove();
      slotNodes.delete(id);
    }
  }

  // add or update nodes
  snapshot.slots.forEach(s=>{
    const id = s.id;
    if(slotNodes.has(id)){
      const node = slotNodes.get(id);
      updateSlotNode(node, s);
    } else {
      const node = makeSlotElement(s);
      container.appendChild(node);
      slotNodes.set(id, node);
    }
    if(highlightId && s.id===highlightId){
      const node = slotNodes.get(id);
      node.scrollIntoView({behavior:'smooth', block:'center'});
      node.classList.add('ring-2','ring-sky-500');
      setTimeout(()=>node.classList.remove('ring-2','ring-sky-500'),1800);
    }
  });
}

/* ---------- Dashboard & modal ---------- */
let currentModal = null;
function updateUI(snap){
  const total = snap.totalSlots;
  const occupiedCount = snap.slots.filter(s=>s.status==='occupied').length;
  const reservedCount = snap.slots.filter(s=>s.status==='reserved').length;
  const offlineCount = snap.slots.filter(s=>s.status==='offline').length;
  const available = total - occupiedCount - reservedCount - offlineCount;

  el('totalSlotsText').innerText = total;
  el('occupied').innerText = occupiedCount;
  el('available').innerText = available<0?0:available;
  el('reservedCount').innerText = reservedCount;
  el('gate').innerText = snap.gateStatus||'Closed';
  el('rateInput').value = (snap.ratePerHour||0).toFixed(2);

  renderGrid(snap);
  renderLogs(snap.logs);
  renderJSON(snap);
}

function renderLogs(logs){
  const box = el('logBox');
  const wasAtBottom = box.scrollTop + box.clientHeight >= box.scrollHeight - 10;
  box.innerHTML = logs.slice(0,200).map(l=>`<div class="text-xs"><span class="muted">${l.time}</span> â€” ${l.text}</div>`).join('');
  if(wasAtBottom) box.scrollTop = box.scrollHeight;
}

function renderJSON(snap){
  const payload = { timestamp: nowIso(), totalSlots:snap.totalSlots, ratePerHour:snap.ratePerHour, gate:snap.gateStatus, slots:snap.slots.map(s=>({id:s.id,status:s.status,enteredAt:s.enteredAt?new Date(s.enteredAt).toISOString():null,reservedUntil:s.reservedUntil?new Date(s.reservedUntil).toISOString():null}))};
  el('jsonPreview').innerText = JSON.stringify(payload,null,2);
}

function openModal(id){
  const s = store.slots.find(x=>x.id===id); if(!s) return;
  currentModal = s;
  el('modalTitle').innerText = `Slot #${s.id}`;
  el('modalStatus').innerText = s.status;
  el('modalEnterAt').innerText = s.enteredAt?new Date(s.enteredAt).toLocaleString():'-';
  el('modalReservedUntil').innerText = s.reservedUntil?new Date(s.reservedUntil).toLocaleString():'-';
  updateModal();
  el('modal').classList.remove('hidden');
}
function closeModal(){ el('modal').classList.add('hidden'); currentModal=null; }
function updateModal(){
  if(!currentModal) return;
  if(currentModal.enteredAt){
    const mins = Math.floor((ts()-currentModal.enteredAt)/60000);
    el('modalElapsed').innerText = `${mins} min`; el('modalFee').innerText = store.feeFor(currentModal).toFixed(2);
  } else { el('modalElapsed').innerText='-'; el('modalFee').innerText='0.00'; }
}

/* ---------- High-level actions with animations ---------- */
async function simulateEnter(){
  const snap = store.snapshot();
  const free = snap.slots.find(s=>s.status==='available');
  if(!free){ alert('No available slots'); store.log('enter failed: none'); return; }
  // find DOM slot
  const dom = slotNodes.get(free.id);
  if(dom) await enterAnimationToSlot(dom, '#8ef7c9');
  store.occupy(free.id);
}

async function simulateExit(){
  const snap = store.snapshot(); const occ = snap.slots.filter(s=>s.status==='occupied').sort((a,b)=>b.id-a.id);
  if(occ.length===0){ alert('No occupied slots'); store.log('exit failed: none'); return; }
  const which = occ[0];
  const dom = slotNodes.get(which.id);
  if(dom) await exitAnimationFromSlot(dom, '#ffb4b4');
  store.free(which.id);
}

function reserveRandom(sec=30){ if(!store.reserveRandom(sec*1000)) alert('No available to reserve'); }
function burst(n=5){ for(let i=0;i<n;i++) setTimeout(()=>simulateEnter(), i*180); }

/* ---------- Charting ---------- */
let chart=null, history=[];
function initChart(){
  const ctx = el('occupancyChart'); history = Array.from({length:30},()=>0);
  chart = new Chart(ctx, { type:'line', data:{ labels:Array(30).fill(''), datasets:[{ label:'Occupied', data:history, fill:true, borderColor:'rgba(99,102,241,0.95)', backgroundColor:'rgba(99,102,241,0.08)', tension:0.35 }] }, options:{ animation:{duration:200}, scales:{ y:{ beginAtZero:true, suggestedMax: store.totalSlots } }, plugins:{legend:{display:false}} }});
}
function sampleAndUpdate(){
  const snap=store.snapshot(); const occ = snap.slots.filter(s=>s.status==='occupied').length;
  history.push(occ); if(history.length>30) history.shift();
  chart.data.datasets[0].data = history; chart.update();
}

/* ---------- Export ---------- */
function exportJSON(){
  const snap = store.snapshot(); const payload = { timestamp:nowIso(), totalSlots:snap.totalSlots, ratePerHour:snap.ratePerHour, gate:snap.gateStatus, slots:snap.slots };
  const b = new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`parking_${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href); store.log('export json');
}
function exportCSV(){
  const snap = store.snapshot(); const rows=[['id','status','enteredAt','reservedUntil']];
  snap.slots.forEach(s=>rows.push([s.id,s.status,s.enteredAt?new Date(s.enteredAt).toISOString():'', s.reservedUntil?new Date(s.reservedUntil).toISOString():'']));
  const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n'); const b=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`parking_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href); store.log('export csv');
}

/* ---------- Periodic tasks & autosim ---------- */
setInterval(()=>{ store.expireReservations(); sampleAndUpdate(); updateModal(); }, 3000);

let auto=false, autoInt=null;
function startAuto(){
  stopAuto();
  const speed = Math.max(200, parseInt(el('speedInput').value || 900));
  autoInt = setInterval(()=> {
    if(store.sensorNoise && Math.random()<0.06){ const off = store.slots.find(s=>s.status==='offline'); if(off) store.toggleOffline(off.id); }
    const snap = store.snapshot(); const occ = snap.slots.filter(s=>s.status==='occupied').length; const free = snap.slots.filter(s=>s.status==='available').length;
    const r = Math.random();
    if((r<0.6 && free>0) || occ===0) simulateEnter(); else simulateExit();
  }, speed);
}
function stopAuto(){ if(autoInt) { clearInterval(autoInt); autoInt=null; } }

/* ---------- Events ---------- */
el('enterBtn').addEventListener('click', simulateEnter);
el('exitBtn').addEventListener('click', simulateExit);
el('reserveBtn').addEventListener('click', ()=> reserveRandom(30));
el('reserveExpiryBtn').addEventListener('click', ()=> reserveRandom(120));
el('applySlotsBtn').addEventListener('click', ()=> { const n=Math.max(1,parseInt(el('totalSlotsInput').value||8)); store.ensureSlots(n); });
el('resetSlotsBtn').addEventListener('click', ()=> { if(!confirm('Set all to available?')) return; store.slots.forEach(s=>{ s.status='available'; s.enteredAt=null; s.reservedUntil=null; }); store.log('reset all available'); store._emit(); });
el('applyRateBtn').addEventListener('click', ()=> { const r=Math.max(0,parseFloat(el('rateInput').value||2)); store.setRate(r); });
el('autoToggle').addEventListener('change', e=>{ auto = e.target.checked; if(auto){ startAuto(); store.log('auto on'); } else { stopAuto(); store.log('auto off'); } });
el('autoBurst').addEventListener('click', ()=> { burst(5); store.log('burst 5'); });
el('toggleSensorNoise').addEventListener('click', ()=> { store.sensorNoise = !store.sensorNoise; el('toggleSensorNoise').innerText = `Sensor Noise: ${store.sensorNoise?'On':'Off'}`; store.log(`sensor noise ${store.sensorNoise?'enabled':'disabled'}`); store._emit(); });
el('speedInput').addEventListener('change', ()=> { if(auto) startAuto(); });
el('exportJSON').addEventListener('click', exportJSON); el('exportJSONTop').addEventListener('click', exportJSON); el('exportJSONBtn').addEventListener('click', exportJSON);
el('downloadCSV').addEventListener('click', exportCSV); el('downloadCSVTop').addEventListener('click', exportCSV);

el('searchBtn').addEventListener('click', ()=> {
  const n = parseInt(el('searchSlot').value); if(!n) return; const snap = store.snapshot(); const found = snap.slots.find(s=>s.id===n);
  if(!found){ alert('not found'); return; } renderGrid(snap,n); store.log(`searched #${n}`);
});

el('modalClose').addEventListener('click', closeModal);
el('modalForceFree').addEventListener('click', ()=>{ if(!currentModal) return; store.free(currentModal.id); closeModal(); });
el('modalForceOccupy').addEventListener('click', ()=>{ if(!currentModal) return; store.occupy(currentModal.id); closeModal(); });
window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

/* ---------- Subscribe & init ---------- */
initChart();
store.subscribe(snap => updateUI(snap));
updateUI(store.snapshot());
sampleAndUpdate();

</script>
</body>
</html>